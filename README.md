# JRA-Data Collector

JRA-VANデータを取得・蓄積するためのPythonアプリケーション

## 🔒 管理者権限について（重要）

本アプリケーションは、JRA-VANのJV-Linkコンポーネントと安定して通信するため、起動時に**管理者権限を要求します**（UACプロンプトが表示されます）。

### なぜ管理者権限が必要なのか？

1. **アーキテクチャの不一致解決**: JV-Linkは32bitのCOMコンポーネントとして提供されていますが、多くの現代的なPython環境は64bitです。64bitプロセスは32bitのDLLを直接ロードできないため、`REGDB_E_CLASSNOTREG`エラー（クラスが登録されていません）が発生します。

2. **DLLサロゲート機能の有効化**: この問題を解決するため、アプリケーションはWindowsの**DLLサロゲート**機能を自動的に有効化します。これにより、32bitのJV-Link COMサーバーを別個の32bitプロセス（`dllhost.exe`）で起動し、64bitのPythonアプリケーションからプロセス間通信を通じて安全に呼び出すことが可能になります。

3. **レジストリ設定の自動構成**: DLLサロゲート機能の有効化には、`HKEY_CLASSES_ROOT`レジストリキーへの書き込み権限が必要です。

### 動作フロー

1. アプリケーション起動時に管理者権限を自動チェック
2. 権限がない場合、UACプロンプトを表示して自動昇格
3. 64bit Python環境の場合、JV-Link用のDLLサロゲート設定を自動構成
4. 設定完了後、通常通りJV-Link COMコンポーネントにアクセス可能

**※ UACプロンプトで「はい」を選択していただくことで、アプリケーションは正常に動作します。**

## 実行方法

このアプリケーションは、UI ライブラリ **qfluentwidgets** の既知の初期化バグを回避するため、実行前に次の環境変数を設定してください。

### Windows (PowerShell)
```powershell
$env:QFLUENT_DISABLE_TIPS="1"
python run.py
```

### Linux / macOS (bash)
```bash
export QFLUENT_DISABLE_TIPS=1
python run.py
```

環境変数を設定すると、`QWidget: Must construct a QApplication before a QWidget` エラーが発生しなくなります。

### 初回起動時の流れ

1. **管理者権限確認**: UACプロンプトが表示されるので「はい」を選択
2. **アーキテクチャ検出**: 64bit Python環境の場合、DLLサロゲート設定を自動実行
3. **JV-Link設定**: アプリケーション起動後、設定画面から「JV-Link設定ダイアログを開く」ボタンでサービスキーを設定
4. **データ取得開始**: セットアップデータ → 差分データ → 速報データの順序で取得可能

## システム要件

- **OS**: Windows 10/11 (64bit推奨)
- **Python**: 3.8以上 (64bit版推奨)
- **JV-Link**: JRA-VAN Data Lab SDK (正式にインストール済み)
- **権限**: 管理者権限 (初回設定時および起動時)

## トラブルシューティング

### よくあるエラーと解決方法

- **REGDB_E_CLASSNOTREG (-2147221164)**: DLLサロゲート設定により自動解決されます
- **UACプロンプト表示**: 「はい」を選択して管理者権限を許可してください
- **JV-Linkが見つからない**: JRA-VAN Data Lab SDKが正しくインストールされているか確認してください 